<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>/* styling omitted for brevity */</style>
</head>
<body>
  <ul id="task-list" class="task-list"></ul>
  <button id="add-task" class="add-task-btn">+ Add New Task</button>
  <script>
    const t = TrelloPowerUp.iframe();
    let members = [];
    let checklistData = [];
    let isSaving = false;

    function loadCachedMembers() {
      t.get('board', 'shared', 'cachedMembers').then(cached => {
        if (Array.isArray(cached)) members = cached;
      });
    }

    function updateChecklistField(taskId, field, value) {
      t.get('card', 'shared', 'taskChecklist').then(existing => {
        const updated = Array.isArray(existing)
          ? existing.map(item => item.taskId === taskId ? { ...item, [field]: value } : item)
          : [];
        console.log(`ðŸ“¦ New checklist state after update:`, updated);
        t.set('card', 'shared', { taskChecklist: updated }).then(() => {
          console.log(`âœ… t.set() succeeded â€” Field "${field}" saved for taskId="${taskId}"`);
        });
      });
    }

    function appendChecklistItem(task) {
      if (isSaving) return;
      isSaving = true;
      setTimeout(() => { isSaving = false }, 1000);

      t.get('card', 'shared', 'taskChecklist').then(existing => {
        const updated = Array.isArray(existing) ? [...existing, task] : [task];
        checklistData = updated;
        t.set('card', 'shared', { taskChecklist: updated }).then(() => {
          console.log('âœ… Task appended to Trello storage:', task);
          refreshChecklistUI();
        });
      });
    }

    function createTaskInputRow() {
      const taskList = document.getElementById('task-list');
      const li = document.createElement('li');
      li.className = 'task-item';
      const inputRow = document.createElement('div');
      inputRow.className = 'task-input-row';
      const taskId = crypto.randomUUID();
      const task = { taskId, name: '', dueDate: '', memberName: '' };

      const nameInput = document.createElement('input');
      nameInput.className = 'task-name';
      nameInput.placeholder = 'Task name...';

      const dateBtn = document.createElement('button');
      dateBtn.className = 'set-date';
      dateBtn.innerHTML = '<span>ðŸ•‘</span> Set Date';
      dateBtn.addEventListener('click', (e) => {
        t.popup({
          type: 'datetime', title: 'Due Date', date: new Date(), mouseEvent: e,
          callback: function (t, opts) {
            if (opts?.date) {
              const selected = new Date(opts.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              console.log('ðŸ“… Date selected:', selected);
              task.dueDate = selected;
              dateBtn.innerHTML = `ðŸ•‘ ${selected}`;
              updateChecklistField(taskId, 'dueDate', selected);
            }
          }
        });
      });

      const assignBtn = document.createElement('button');
      assignBtn.className = 'assign-member';
      assignBtn.innerHTML = '<span>ðŸ‘¤</span> Assign';
      assignBtn.addEventListener('click', (e) => {
        t.popup({
          title: 'Assign Member',
          url: 'member-picker.html',
          height: 300,
          mouseEvent: e,
          args: { taskId },
          callback: function (t, opts) {
            if (opts?.memberName) {
              console.log(`[Member Picker] Selected: ${opts.memberName}`);
              assignBtn.innerHTML = `ðŸ‘¤ ${opts.memberName}`;
              task.memberName = opts.memberName;
              updateChecklistField(taskId, 'memberName', opts.memberName);
            }
          }
        });
      });

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.textContent = 'Add';
      addBtn.addEventListener('click', () => {
        task.name = nameInput.value;
        if (!task.name.trim()) return;
        appendChecklistItem(task);
      });

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', () => li.remove());

      inputRow.append(nameInput, dateBtn, assignBtn, addBtn, cancelBtn);
      li.appendChild(inputRow);
      taskList.appendChild(li);
    }

    function refreshChecklistUI() {
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';
      checklistData.forEach(task => {
        const li = document.createElement('li');
        li.className = 'task-item';
        li.innerHTML = `
          <input type="text" class="task-name" value="${task.name}" disabled />
          <button class="set-date">ðŸ•‘ ${task.dueDate || 'No Date'}</button>
          <button class="assign-member">ðŸ‘¤ ${task.memberName || 'Unassigned'}</button>
          <button class="three-dots">â‹®</button>`;
        taskList.appendChild(li);
      });
    }

    let hasRendered = false;
    t.render(() => {
      if (hasRendered) return;
      hasRendered = true;
      loadCachedMembers();
      t.get('card', 'shared', 'taskChecklist').then(saved => {
        if (Array.isArray(saved)) {
          checklistData = saved;
          refreshChecklistUI();
        }
      });
      document.getElementById('add-task').addEventListener('click', createTaskInputRow);
    });
  </script>
</body>
</html>
