<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create/Edit Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <h3>Create/Edit Task Checklist</h3>
  <form id="task-checklist-form">
    <div>
      <label for="checklist-name">Checklist Name:</label>
      <input type="text" id="checklist-name" name="checklist-name" value="Task Checklist" required>
    </div>
    <div>
      <button type="submit">Save Checklist</button>
    </div>
  </form>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var t = TrelloPowerUp.iframe();
      const TRELLO_API_KEY = "7443867af11d32c3e8f8152b114201fd";

      // Retrieve the user-specific token from private storage.
      function getUserToken() {
        return t.get('member', 'private', 'trello_token')
          .then(function(token) {
            if (!token) {
              throw new Error("User not authorized");
            }
            return token;
          });
      }

      document.getElementById('task-checklist-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var checklistName = document.getElementById('checklist-name').value;
        // Get the current card ID.
        t.card('id').then(function(card) {
          return getUserToken().then(function(userToken) {
            var cardId = card.id;
            var url = `https://api.trello.com/1/cards/${cardId}/checklists?name=${encodeURIComponent(checklistName)}&key=${TRELLO_API_KEY}&token=${userToken}`;
            return fetch(url, { method: 'POST' });
          });
        })
        .then(function(response) {
          if (!response.ok) {
            return response.text().then(text => { throw new Error(text); });
          }
          return response.json();
        })
        .then(function(checklistData) {
          // Save the checklist ID in the card's shared storage.
          return t.set('card', 'shared', 'taskChecklistId', checklistData.id);
        })
        .then(function() {
          t.closePopup();
        })
        .catch(function(err) {
          console.error("Error creating checklist:", err);
        });
      });
    });
  </script>
</body>
</html>
