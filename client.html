<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f4f5f7;
      margin-bottom: 6px;
      padding: 8px;
      border-radius: 4px;
    }
    .task-name {
      font-size: 14px;
      font-weight: 500;
    }
    .task-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #555;
    }
    .meta-due, .meta-member {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .meta-due i, .meta-member i {
      font-style: normal;
      font-weight: bold;
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .btn {
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-add {
      background: #026aa7;
      color: white;
      font-weight: bold;
      margin-top: 10px;
      width: 100%;
    }
    .edit-zone {
      margin-top: 10px;
    }
    .edit-zone input, .edit-zone select {
      padding: 6px;
      margin-right: 10px;
    }
    .edit-zone button {
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h3>Task Checklist</h3>

<div class="edit-zone" id="edit-zone">
  <input type="text" id="task-input" placeholder="Add an item" />
  <select id="member-select">
    <option value="">Assign Member</option>
  </select>
  <input type="date" id="due-input" />
  <button id="add-task-btn">Add</button>
</div>

<ul id="task-list" class="task-list"></ul>

<script>
  const t = TrelloPowerUp.iframe();
  let members = [];

  async function loadMembers() {
    const context = await t.getContext();
    const boardId = context.board;
    const token = await t.get('member', 'private', 'trello_token');
    const apiKey = "7443867af11d32c3e8f8152b114201fd";

    const res = await fetch(`https://api.trello.com/1/boards/${boardId}/members?key=${apiKey}&token=${token}`);
    members = await res.json();

    const select = document.getElementById('member-select');
    members.forEach(member => {
      const opt = document.createElement('option');
      opt.value = member.id;
      opt.textContent = member.fullName;
      select.appendChild(opt);
    });
  }

  function addTask(name, memberId, dueDate) {
    const taskList = document.getElementById('task-list');

    const li = document.createElement('li');
    li.className = 'task-item';

    const member = members.find(m => m.id === memberId);
    const memberName = member ? member.fullName : 'No member';
    const memberInitial = member ? member.initials : '';

    li.innerHTML = `
      <div class="task-name">${name}</div>
      <div class="task-meta">
        <div class="meta-due"><i>‚è∞</i> ${dueDate}</div>
        <div class="meta-member"><i>üë§</i> ${memberName}</div>
      </div>
    `;

    taskList.appendChild(li);
  }

  document.getElementById('add-task-btn').addEventListener('click', () => {
    const name = document.getElementById('task-input').value.trim();
    const memberId = document.getElementById('member-select').value;
    const dueDate = document.getElementById('due-input').value;

    if (!name) {
      alert('Task name required.');
      return;
    }

    addTask(name, memberId, dueDate || new Date().toISOString().substring(0,10));

    // Clear input fields
    document.getElementById('task-input').value = '';
    document.getElementById('member-select').value = '';
    document.getElementById('due-input').value = '';
  });

  t.render(() => {
    loadMembers();
  });
</script>

</body>
</html>
