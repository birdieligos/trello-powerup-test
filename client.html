<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    .task-checklist {
      margin-top: 10px;
    }
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .task-info {
      display: flex;
      flex-direction: column;
    }
    .task-actions {
      cursor: pointer;
      padding: 5px;
    }
    .add-task-btn {
      margin-top: 10px;
      padding: 8px;
      background-color: #026AA7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .task-name {
      font-weight: bold;
    }
    .task-meta {
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>
<div class="task-checklist">
  <div id="task-list"></div>
  <button id="add-task" class="add-task-btn">+ Add New Task</button>
</div>

<script>
const t = TrelloPowerUp.iframe();
const API_KEY = '7443867af11d32c3e8f8152b114201fd';

async function getUserToken() {
  const token = await t.get('member', 'private', 'trello_token');
  if (!token) throw new Error('User not authorized');
  return token;
}

function renderChecklist(tasks) {
  const list = document.getElementById('task-list');
  list.innerHTML = '';
  tasks.forEach((task, idx) => {
    const div = document.createElement('div');
    div.className = 'task-item';
    div.innerHTML = `
      <div class="task-info">
        <div class="task-name">${task.name}</div>
        <div class="task-meta">Due: ${task.due || 'None'} | Member: ${task.member || 'None'}</div>
      </div>
      <div class="task-actions" data-idx="${idx}">&#x22EE;</div>
    `;
    list.appendChild(div);

    div.querySelector('.task-actions').addEventListener('click', async e => {
      const action = prompt('Type "create" to Create Task Card or "delete" to Delete Task');
      if (action === 'create') {
        if (!task.due || !task.member) {
          alert('Task must have Date and Member assigned to create card.');
          return;
        }
        const { id: parentId, idBoard } = await t.card('id', 'idBoard');
        const token = await getUserToken();

        const lists = await fetch(`https://api.trello.com/1/boards/${idBoard}/lists?key=${API_KEY}&token=${token}`)
          .then(r => r.json());
        const targetList = lists.find(l => l.name === 'TASK | On the Horizon');
        if (!targetList) throw new Error('TASK | On the Horizon list not found');

        const params = new URLSearchParams({
          name: task.name,
          idList: targetList.id,
          due: task.due,
          idMembers: task.member,
          key: API_KEY,
          token
        });

        const card = await fetch(`https://api.trello.com/1/cards?${params.toString()}`, { method: 'POST' })
          .then(r => r.json());

        // Link Parent-Child via Hello Epics
        await fetch(`https://api.helloepics.com/link?parent=${parentId}&child=${card.id}&key=${API_KEY}&token=${token}`, {
          method: 'POST'
        });

        alert('Task Card created!');
      } else if (action === 'delete') {
        tasks.splice(idx, 1);
        t.set('card', 'shared', 'checklistData', tasks);
        renderChecklist(tasks);
      }
    });
  });
}

async function loadChecklist() {
  const tasks = await t.get('card', 'shared', 'checklistData') || [];
  renderChecklist(tasks);
}

document.getElementById('add-task').addEventListener('click', async () => {
  const name = prompt('Task Name');
  if (!name) return;
  const due = prompt('Due Date (YYYY-MM-DD)');
  const member = prompt('Member ID(s) (comma separated)');
  
  const tasks = await t.get('card', 'shared', 'checklistData') || [];
  tasks.push({ name, due, member });
  await t.set('card', 'shared', 'checklistData', tasks);
  renderChecklist(tasks);
});

loadChecklist();
</script>
</body>
</html>
