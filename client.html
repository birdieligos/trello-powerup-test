<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create/Edit Task Checklist</title>
  <!-- Load the Trello Power-Up client library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <h3>Create/Edit Task Checklist</h3>
  <form id="task-checklist-form">
    <div>
      <label for="checklist-name">Checklist Name:</label>
      <input type="text" id="checklist-name" name="checklist-name" value="Task Checklist" required>
    </div>
    <div>
      <button type="submit">Save Checklist</button>
    </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const t = TrelloPowerUp.iframe();
      // Trello API credentials (for demo purposes only; do not expose secrets in production)
      const TRELLO_API_KEY = "7443867af11d32c3e8f8152b114201fd";
      const TRELLO_TOKEN = "ae53988077e16ae1a2d07602b5ff53b987f22d7a6348b7ef913c863ff79aa189";

      // When the form is submitted, create a new checklist on the card.
      document.getElementById('task-checklist-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const checklistName = document.getElementById('checklist-name').value;
        
        // Get the current card's ID.
        t.card('id').then(function(card) {
          const cardId = card.id;
          // Build the URL for creating a checklist via the Trello API.
          const url = `https://api.trello.com/1/cards/${cardId}/checklists?name=${encodeURIComponent(checklistName)}&key=${TRELLO_API_KEY}&token=${TRELLO_TOKEN}`;
          return fetch(url, { method: 'POST' });
        })
        .then(response => response.json())
        .then(checklistData => {
          // Save the checklist ID in the card's shared storage.
          return t.set('card', 'shared', 'taskChecklistId', checklistData.id);
        })
        .then(() => {
          // Close the popup after saving.
          t.closePopup();
        })
        .catch(err => {
          console.error("Error creating checklist:", err);
        });
      });
    });
  </script>
</body>
</html>
