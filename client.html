<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Checklist Section</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
    }
    .checklist-container {
      padding: 10px;
    }
    .task {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    .task-name {
      font-weight: 500;
    }
    .task-options {
      cursor: pointer;
      font-size: 18px;
    }
    .add-task {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #026AA7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="checklist-container">
    <h3>Task Checklist</h3>
    <div id="task-list"></div>
    <button class="add-task" id="add-task-btn">+ Add New Task</button>
  </div>

  <script>
    const t = TrelloPowerUp.iframe();
    const taskList = document.getElementById('task-list');

    async function loadTasks() {
      const tasks = await t.get('card', 'shared', 'taskChecklist') || [];
      taskList.innerHTML = '';
      tasks.forEach(renderTask);
    }

    function renderTask(taskText) {
      const div = document.createElement('div');
      div.className = 'task';
      div.innerHTML = `
        <div class="task-name">${taskText}</div>
        <div class="task-options">&#x22EE;</div>
      `;
      div.querySelector('.task-options').addEventListener('click', () => {
        const choice = prompt('Type "create" to Create Task Card or "delete" to Delete Task');
        if (choice === 'create') {
          createTaskCard(taskText);
        } else if (choice === 'delete') {
          deleteTask(taskText);
        }
      });
      taskList.appendChild(div);
    }

    async function createTaskCard(name) {
      const { idBoard } = await t.card('idBoard');
      const token = await t.get('member', 'private', 'trello_token');
      const lists = await fetch(`https://api.trello.com/1/boards/${idBoard}/lists?key=7443867af11d32c3e8f8152b114201fd&token=${token}`)
        .then(res => res.json());
      const targetList = lists.find(l => l.name.includes('TASK | On the Horizon'));
      if (!targetList) return alert('Target list not found');

      await fetch(`https://api.trello.com/1/cards`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: name,
          idList: targetList.id,
          key: '7443867af11d32c3e8f8152b114201fd',
          token: token
        })
      });
      alert('Task Card Created!');
    }

    async function deleteTask(taskText) {
      let tasks = await t.get('card', 'shared', 'taskChecklist') || [];
      tasks = tasks.filter(task => task !== taskText);
      await t.set('card', 'shared', 'taskChecklist', tasks);
      loadTasks();
    }

    document.getElementById('add-task-btn').addEventListener('click', async () => {
      const taskName = prompt('Enter Task Name');
      if (!taskName) return;
      const tasks = await t.get('card', 'shared', 'taskChecklist') || [];
      tasks.push(taskName);
      await t.set('card', 'shared', 'taskChecklist', tasks);
      loadTasks();
    });

    loadTasks();
  </script>
</body>
</html>
