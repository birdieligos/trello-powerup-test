<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    .task-entry { margin-top:10px }
    .task-entry input { margin-right:5px }
  </style>
</head>
<body>
  <h3>Create Task Checklist</h3>
  <form id="create-task-form">
    <div>
      <label for="checklist-name">Checklist Name:</label>
      <input type="text" id="checklist-name" name="checklist-name"
             value="Task Checklist" required>
    </div>
    <div id="tasks-container"></div>
    <button type="button" id="add-task">Add Task</button>
    <div><button type="submit">Create Checklist</button></div>
  </form>

  <script>
    const t = TrelloPowerUp.iframe();
    const API_KEY = '7443867af11d32c3e8f8152b114201fd';

    function createTaskElement(idx) {
      const d = document.createElement('div');
      d.className = 'task-entry';
      d.innerHTML = `
        <input id="task-name-${idx}" name="task-name-${idx}"
               class="task-name" placeholder="Task name" required>
        <input id="task-date-${idx}" name="task-date-${idx}"
               type="date" class="task-date" required>
        <input id="task-member-${idx}" name="task-member-${idx}"
               class="task-member" placeholder="@username" required>
      `;
      return d;
    }

    document.getElementById('add-task').onclick = () => {
      const container = document.getElementById('tasks-container');
      container.appendChild(createTaskElement(container.children.length));
    };

    document.getElementById('create-task-form').onsubmit = async e => {
      e.preventDefault();
      const checklistName = document.getElementById('checklist-name').value;
      const entries = Array.from(document.querySelectorAll('.task-entry'));
      const { id: cardId, idBoard } = await t.card('id','idBoard');
      const token = await t.get('member','private','trello_token');
      // 1) create checklist
      let res = await fetch(
        `https://api.trello.com/1/cards/${cardId}/checklists` +
        `?name=${encodeURIComponent(checklistName)}` +
        `&key=${API_KEY}&token=${token}`,
        { method:'POST' }
      );
      const { id: checklistId } = await res.json();
      await t.set('card','shared','taskChecklistId',checklistId);

      // 2) create items + store metadata
      for (let n=0; n<entries.length; n++) {
        const e = entries[n];
        const name   = e.querySelector('.task-name').value;
        const date   = e.querySelector('.task-date').value;
        const member = e.querySelector('.task-member').value.replace(/^@/,'');
        // create checklist item
        res = await fetch(
          `https://api.trello.com/1/checklists/${checklistId}/checkItems` +
          `?name=${encodeURIComponent(name)}` +
          `&key=${API_KEY}&token=${token}`,
          { method:'POST' }
        );
        const { id: itemId } = await res.json();
        // store metadata for later
        await t.set(
          'card','shared',`taskMeta-${itemId}`,
          { due: date, member, done: false }
        );
      }

      t.closePopup();
    };
  </script>
</body>
</html>
