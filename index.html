<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trello Power-Up: Task Checklist & Authorization</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const API_KEY = '7443867af11d32c3e8f8152b114201fd';

  document.addEventListener('DOMContentLoaded', () => {
    TrelloPowerUp.initialize({
      // 1) OAuth
      'authorization-status': t =>
        t.get('member','private','trello_token')
         .then(token => ({ authorized: !!token })),

      'show-authorization': t =>
        t.popup({
          title: 'Authorize Power-Up',
          url: './authorize.html',
          height: 150
        }),

      // 2) Card button to launch the Task‑Checklist popup
      'card-buttons': t => [{
        text: 'Create Task Checklist',
        callback: t =>
          t.popup({
            title: 'Create Task Checklist',
            url: './client.html',
            height: 250
          })
      }],

      // 3) Badge on each checklist item to convert it into a Task card
      'card-detail-badges': async (t, { checklist, checkItem }) => {
        if (!checklist || !checkItem) return [];

        return [{
          text: 'Create Task Card',
          callback: async t => {
            const { id: cardId, idBoard } = await t.card('id','idBoard');
            const token = await t.get('member','private','trello_token');

            // find the “TASK | On the Horizon” list
            const lists = await fetch(
              `https://api.trello.com/1/boards/${idBoard}/lists?key=${API_KEY}&token=${token}`
            ).then(r => r.json());

            const target = lists.find(l => l.name === 'TASK | On the Horizon');
            if (!target) throw new Error('Task list not found');

            // create new card named after the checklist item
            await fetch(
              `https://api.trello.com/1/cards?` +
              `name=${encodeURIComponent(checkItem.name)}` +
              `&idList=${target.id}` +
              `&key=${API_KEY}&token=${token}`,
              { method: 'POST' }
            );

            return t.reload();
          }
        }];
      },

      // 4) Required to re-render badges & buttons
      'onRender': t => t.render()
    });
  });
</script>
</body>
</html>
