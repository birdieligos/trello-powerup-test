<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trello Powerâ€‘Up (1.6.6)</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const API_KEY = '7443867af11d32c3e8f8152b114201fd';

  function log(step, data) {
    console.groupCollapsed(`ðŸ”” [TPU] ${step}`);
    if (data !== undefined) console.log(data);
    console.groupEnd();
  }

  TrelloPowerUp.initialize({
    // 1. OAuth
    'authorization-status': t => {
      log('authorization-status');
      return t.get('member','private','trello_token')
        .then(tok => ({ authorized: !!tok }));
    },
    'show-authorization': t => {
      log('show-authorization');
      return t.popup({
        title: 'Authorize Powerâ€‘Up',
        url: './authorize.html',
        height: 150
      });
    },

    // 2. Card button
    'card-buttons': t => {
      log('card-buttons');
      return [{
        text: 'Create Task Checklist',
        callback: async t => {
          log('card-button clicked');
          const { id: cardId } = await t.card('id');
          log('card id', cardId);
          const token = await t.get('member','private','trello_token');
          log('token exists?', !!token);

          const res = await fetch(
            `https://api.trello.com/1/cards/${cardId}/checklists` +
            `?name=${encodeURIComponent('Task Checklist')}` +
            `&key=${API_KEY}&token=${token}`,
            { method: 'POST' }
          );
          const ch = await res.json();
          log('checklist created', ch);

          // tell Trello to reâ€‘render card
          return { refresh: true };
        }
      }];
    },

    // 3. Stub frontâ€‘ofâ€‘card badges
    'card-badges': t => {
      log('card-badges stub');
      return [];
    },

    // 4. Stub detailâ€‘ofâ€‘card badges
    'card-detail-badges': async t => {
      log('card-detail-badges stub');
      return [];
    },

    // 5. Checklistâ€‘item â€œâ€¦â€ menu action
    'checklist-actions': async (t, { checklist, checkItem }) => {
      log('checklist-actions', { checklist, checkItem });
      if (!checklist || checklist.name !== 'Task Checklist') {
        log('â†’ not Task Checklist, skip');
        return [];
      }
      return [{
        text: 'Convert to Task Card',
        callback: async t => {
          log('menu action clicked', checkItem.name);

          const { id: parentId, idBoard } = await t.card('id','idBoard');
          log('parent/cardBoard IDs', { parentId, idBoard });
          const token = await t.get('member','private','trello_token');
          log('token exists?', !!token);

          const meta = await t.get('card','shared', `taskMeta-${checkItem.id}`) || {};
          log('item metadata', meta);

          const lists = await fetch(
            `https://api.trello.com/1/boards/${idBoard}/lists?key=${API_KEY}&token=${token}`
          ).then(r => r.json());
          log('lists', lists.map(l => l.name));

          const target = lists.find(l => l.name === 'TASK | On the Horizon');
          log('target list', target);
          if (!target) throw new Error('TASK | On the Horizon not found');

          const params = new URLSearchParams({
            name: checkItem.name,
            idList: target.id,
            ...(meta.due    && { due: meta.due    }),
            ...(meta.member && { idMembers: meta.member }),
            ...(meta.done   && { dueComplete: meta.done }),
            key: API_KEY,
            token
          });
          log('create card params', params.toString());

          const newCard = await fetch(
            `https://api.trello.com/1/cards?${params.toString()}`,
            { method: 'POST' }
          ).then(r => r.json());
          log('new card', newCard);

          await fetch(
            `https://api.helloepics.com/link?parent=${parentId}` +
            `&child=${newCard.id}&key=${API_KEY}&token=${token}`,
            { method: 'POST' }
          );
          log('linked epic', { parentId, child: newCard.id });

          await t.set('card','shared', `taskCard-${checkItem.id}`, newCard.id);
          log('stored mapping', newCard.id);

          return { refresh: true };
        }
      }];
    },

    // 6. Allow UI refresh after our callbacks
    'on-render': t => {
      log('on-render');
      return t.render();
    }
  });

  log('TPU initialized');
</script>
</body>
</html>
