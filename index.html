<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Checklist</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const fetchMembersSilently = (t) => {
    console.log('🔄 Starting silent member fetch...');
    return t.board('id')
      .then(board =>
        t.get('member', 'private', 'trello_token')
          .then(token => {
            console.log('📡 Fetching members for board:', board.id);
            return fetch(`https://api.trello.com/1/boards/${board.id}/members?key=7443867af11d32c3e8f8152b114201fd&token=${token}`);
          })
      )
      .then(res => res.json())
      .then(members => {
        console.log('✅ Members fetched:', members);
        return t.set('board', 'shared', { cachedMembers: members });
      })
      .catch(err => {
        console.error('❌ Failed to fetch members:', err);
      });
  };

  window.TrelloPowerUp.initialize({

    'authorization-status': t =>
      t.get('member', 'private', 'trello_token')
        .then(token => {
          console.log('🔐 Auth status:', !!token);
          return { authorized: !!token };
        }),

    'show-authorization': t =>
      t.popup({
        title: 'Authorize',
        url: './authorize.html',
        height: 150
      }),

    'card-back-section': (t) => ({
      title: 'Task Checklist',
      icon: 'https://birdieligos.github.io/trello-powerup-test/icon.jpeg',
      content: {
        type: 'iframe',
        url: t.signUrl('./client.html'),
        height: 500
      },
      action: {
        text: 'Add Task',
        callback: (t) => {
          console.log('🟦 "Add Task" button clicked — sending message to client');
          return t.postMessage({ type: 'add-task-inline' });
        }
      }
    }),

    'board-buttons': (t) => {
      console.log('📌 Board opened — fetching members silently');
      fetchMembersSilently(t);
      return [];
    },

    'popup': t => [],
    'card-buttons': t => [],
    'card-badges': t => [],
    'attachment-sections': t => [],
    'card-detail-badges': t => []

  });
</script>
</body>
</html>
