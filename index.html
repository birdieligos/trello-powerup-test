<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trello Powerâ€‘Up (Verbose Logging)</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const API_KEY = '7443867af11d32c3e8f8152b114201fd';

  function log(section, data) {
    console.groupCollapsed(`ðŸ”” [Power-Up] ${section}`);
    if (data !== undefined) console.log(data);
    console.groupEnd();
  }

  TrelloPowerUp.initialize({
    'authorization-status': t => {
      log('authorization-status called');
      return t.get('member','private','trello_token')
        .then(token => {
          log('authorization-status result', { tokenExists: !!token });
          return { authorized: !!token };
        })
        .catch(err => {
          console.error('[Power-Up] authorization-status error', err);
          throw err;
        });
    },

    'show-authorization': t => {
      log('show-authorization');
      return t.popup({ title: 'Authorize Powerâ€‘Up', url: './authorize.html', height: 150 })
        .then(() => log('show-authorization popup opened'))
        .catch(err => console.error('[Power-Up] show-authorization error', err));
    },

    'card-buttons': t => {
      log('card-buttons registering');
      return [{
        text: 'Create Task Checklist',
        callback: async t => {
          log('card-button click: Create Task Checklist');
          try {
            const { id: cardId } = await t.card('id');
            log('card-id', cardId);

            const token = await t.get('member','private','trello_token');
            log('token fetched', { tokenExists: !!token });

            const res = await fetch(
              `https://api.trello.com/1/cards/${cardId}/checklists` +
              `?name=${encodeURIComponent('Task Checklist')}` +
              `&key=${API_KEY}&token=${token}`,
              { method: 'POST' }
            );
            const body = await res.json();
            log('checklist created', body);

            await t.render();
            log('t.render() called after creating checklist');
          } catch (err) {
            console.error('[Power-Up] card-buttons callback error', err);
            throw err;
          }
        }
      }];
    },

    'checklist-actions': async (t, { checklist, checkItem }) => {
      log('checklist-actions called', { checklist, checkItem });
      if (!checklist || checklist.name !== 'Task Checklist') {
        log('â†’ skipping, not Task Checklist');
        return [];
      }
      return [{
        text: 'Convert to Task Card',
        callback: async t => {
          log('menu-click: Convert to Task Card', checkItem.name);
          try {
            const { id: parentId, idBoard } = await t.card('id','idBoard');
            log('parent and board IDs', { parentId, idBoard });

            const token = await t.get('member','private','trello_token');
            log('token fetched', { tokenExists: !!token });

            const meta = await t.get('card','shared', `taskMeta-${checkItem.id}`) || {};
            log('loaded metadata', meta);

            const lists = await fetch(
              `https://api.trello.com/1/boards/${idBoard}/lists?key=${API_KEY}&token=${token}`
            ).then(r => r.json());
            log('lists fetched', lists.map(l => l.name));

            const target = lists.find(l => l.name === 'TASK | On the Horizon');
            log('target list', target);

            const params = new URLSearchParams({
              name: checkItem.name,
              idList: target.id,
              ...(meta.due    && { due: meta.due }),
              ...(meta.member && { idMembers: meta.member }),
              ...(meta.done   && { dueComplete: meta.done }),
              key: API_KEY,
              token
            });
            log('creating card with params', params.toString());

            const newCard = await fetch(
              `https://api.trello.com/1/cards?${params.toString()}`,
              { method: 'POST' }
            ).then(r => r.json());
            log('new card created', newCard);

            await fetch(
              `https://api.helloepics.com/link?parent=${parentId}` +
              `&child=${newCard.id}&key=${API_KEY}&token=${token}`,
              { method: 'POST' }
            );
            log('linked epic', { parentId, child: newCard.id });

            await t.set('card','shared', `taskCard-${checkItem.id}`, newCard.id);
            log('persisted mapping', { [`taskCard-${checkItem.id}`]: newCard.id });

            await t.render();
            log('t.render() called after conversion');
          } catch (err) {
            console.error('[Power-Up] checklist-actions callback error', err);
            throw err;
          }
        }
      }];
    },

    'on-render': t => {
      log('on-render');
      return t.render();
    }
  });

  log('Power-Up script loaded');
</script>
</body>
</html>
