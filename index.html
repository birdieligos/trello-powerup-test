<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trello Power-Up: Task Checklist & Authorization</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      TrelloPowerUp.initialize({
        // Check if the user has already authorized (token stored in private member storage)
        'authorization-status': function(t, options) {
          return t.get('member', 'private', 'trello_token')
            .then(function(token) {
              return { authorized: !!token };
            });
        },
        // If not authorized, show the authorization popup.
        'show-authorization': function(t, options) {
          return t.popup({
            title: 'Authorize Power-Up',
            url: './authorize.html',
            height: 150
          });
        },
        // Add a button to the card (using card-buttons capability) to create or edit a task checklist.
        'card-buttons': function(t, options) {
          return t.get('card', 'shared', 'taskChecklistId')
            .then(function(taskChecklistId) {
              var btnText = taskChecklistId ? 'Edit Task Checklist' : 'Create Task Checklist';
              return [{
                text: btnText,
                callback: function(t, options) {
                  return t.popup({
                    title: btnText,
                    url: './client.html',  // your checklist creation/editing popup
                    height: 250
                  });
                }
              }];
            });
        },
        // Optional: add a badge in the card detail view for quick access.
        'card-detail-badges': function(t, options) {
          return t.get('card', 'shared', 'taskChecklistId')
            .then(function(taskChecklistId) {
              if (taskChecklistId) {
                return [{
                  title: 'Task Checklist',
                  text: 'Edit',
                  callback: function(t) {
                    return t.popup({
                      title: 'Edit Task Checklist',
                      url: './client.html',
                      height: 250
                    });
                  }
                }];
              }
              return [];
            });
        }
      });
    });
  </script>
</body>
</html>
