<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trello Powerâ€‘Up</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
<script>
  const API_KEY = '7443867af11d32c3e8f8152b114201fd';

  TrelloPowerUp.initialize({
    'authorization-status': t =>
      t.get('member','private','trello_token')
       .then(token=>({authorized:!!token})),

    'show-authorization': t =>
      t.popup({ title:'Authorize', url:'./authorize.html', height:150 }),

    'card-buttons': t=>[{
      text:'Create Task Checklist',
      callback:t=>
        t.popup({ title:'Create Task Checklist', url:'./client.html', height:250 })
    }],

    'card-badges': t=>[], // stub for HelloÂ Epics

    'card-detail-badges': async (t,{checklist,checkItem})=>{
      console.log('ðŸ”” badge handler called for checklist:', checklist && checklist.name, 'item:', checkItem && checkItem.name);
      // only show on our Task Checklist
      if (!checklist || checklist.name !== 'Task Checklist') {
        return [];
      }
      return [{
        text:'Create Task Card',
        callback: async t => {
          // (your existing conversion logic here)
          const {id:parentId,idBoard}=await t.card('id','idBoard');
          const token=await t.get('member','private','trello_token');
          const lists=await fetch(
            `https://api.trello.com/1/boards/${idBoard}/lists?key=${API_KEY}&token=${token}`
          ).then(r=>r.json());
          const target=lists.find(l=>l.name==='TASK | On the Horizon');
          if(!target) throw new Error('List not found');
          const {id:newCardId}=await fetch(
            `https://api.trello.com/1/cards?`+
            `name=${encodeURIComponent(checkItem.name)}`+
            `&idList=${target.id}&key=${API_KEY}&token=${token}`,
            {method:'POST'}
          ).then(r=>r.json());
          await fetch(
            `https://api.helloepics.com/link?parent=${parentId}`+
            `&child=${newCardId}&key=${API_KEY}&token=${token}`,
            {method:'POST'}
          );
          return t.reload();
        }
      }];
    },

    'on-render': t=>t.render()
  });
</script>
</body>
</html>
