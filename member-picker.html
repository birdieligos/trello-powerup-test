<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Select Member</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body style="font-family:sans-serif;padding:10px">
  <ul id="member-list" style="list-style:none;padding:0;margin:0"></ul>

  <script>
    const t = TrelloPowerUp.iframe();
    const list = document.getElementById('member-list');

    async function loadMembers() {
      try {
        const board = await t.board('id');
        const token = await t.get('member', 'private', 'trello_token');
        const res = await fetch(`https://api.trello.com/1/boards/${board.id}/members?key=7443867af11d32c3e8f8152b114201fd&token=${token}`);
        const members = await res.json();

        members.forEach(m => {
          const li = document.createElement('li');
          li.style.marginBottom = '10px';
          li.style.cursor = 'pointer';
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.innerHTML = `
            <img src="${m.avatarUrl ? m.avatarUrl + '/30.png' : ''}" style="border-radius:50%;width:24px;height:24px;margin-right:8px">
            ${m.fullName}
          `;
          li.addEventListener('click', () => {
            t.closePopup({
              id: m.id,
              avatar: m.avatarUrl ? m.avatarUrl + '/30.png' : '',
              name: m.fullName
            });
          });
          list.appendChild(li);
        });

      } catch (e) {
        list.innerHTML = `<li style="color:red">⚠️ Failed to load members</li>`;
        console.error('Failed to load members:', e);
      }
    }

    loadMembers();
  </script>
</body>
</html>
