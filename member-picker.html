<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Select Member</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    ul { list-style: none; padding: 0; margin: 0; }
    li.member-item {
      margin-bottom: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 6px;
      border-radius: 4px;
    }
    li.member-item.selected {
      background-color: #e4f0f6;
      font-weight: bold;
    }
    .checkmark {
      margin-left: auto;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body style="font-family:sans-serif;padding:10px">
  <ul id="member-list"></ul>

  <script>
    const t = TrelloPowerUp.iframe();
    const list = document.getElementById('member-list');
    const taskId = t.arg('taskId');

    async function loadMembers() {
      try {
        const board = await t.board('id');
        const token = await t.get('member', 'private', 'trello_token');
        const res = await fetch(`https://api.trello.com/1/boards/${board.id}/members?key=7443867af11d32c3e8f8152b114201fd&token=${token}`);
        const members = await res.json();
        console.log(`[Member Picker] Loaded ${members.length} members`);

        members.sort((a, b) => a.fullName.localeCompare(b.fullName));

        members.forEach(m => {
          const li = document.createElement('li');
          li.className = 'member-item';
          li.innerHTML = `üë§ ${m.fullName} <span class="checkmark" style="display:none">‚úì</span>`;

          li.addEventListener('click', () => {
            console.log(`[Member Picker] Selected: ${m.fullName}`);
            document.querySelectorAll('.member-item').forEach(el => {
              el.classList.remove('selected');
              el.querySelector('.checkmark').style.display = 'none';
            });
            li.classList.add('selected');
            li.querySelector('.checkmark').style.display = 'inline';

            setTimeout(() => {
              t.get('card', 'shared', 'taskChecklist').then(existing => {
                const updated = Array.isArray(existing) ? [...existing] : [];
                const newList = updated.map(item => {
                  if (item.taskId === taskId) {
                    return { ...item, memberAvatar: m.fullName };
                  }
                  return item;
                });
                t.set('card', 'shared', { taskChecklist: newList }).then(() => {
                  console.log(`‚úÖ Member '${m.fullName}' saved to task with ID: ${taskId}`);
                  t.closePopup({ id: m.id, name: m.fullName });
                });
              });
            }, 300);
          });

          list.appendChild(li);
        });

      } catch (err) {
        list.innerHTML = `<li style="color:red">‚ö†Ô∏è Failed to load members</li>`;
        console.error('[Member Picker] Error loading members:', err);
      }
    }

    loadMembers();
  </script>
</body>
</html>
